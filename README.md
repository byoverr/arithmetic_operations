# Arithmetic Operations


<details><summary><b>Требования к заданию</b></summary>

Пользователь хочет считать арифметические выражения. 
Он вводит строку `2 + 2 * 2` и хочет получить в ответ `6`. 
Но наши операции сложения и умножения (также деления и вычитания) выполняются **"очень-очень" долго**. 
Поэтому вариант, при котором пользователь делает http-запрос и получает в качетсве ответа результат, **невозможна**. 
Более того: вычисление каждой такой операции в нашей **"альтернативной реальности"** занимает **"гигантские"** вычислительные мощности. 
Соответственно, каждое действие мы должны уметь выполнять отдельно и масштабировать эту систему можем добавлением вычислительных мощностей в нашу систему в виде новых "**машин**". 
Поэтому пользователь, присылая выражение, получает в ответ идентификатор выражения и может с какой-то периодичностью уточнять у сервера "не посчиталость ли выражение"? 
Если выражение наконец будет вычислено - то он получит результат. 
Помните, что некоторые части арфиметического выражения можно вычислять **параллельно**.

## Front-end часть

### GUI, который можно представить как 4 страницы

1) Форма ввода арифметического выражения. Пользователь вводит арифметическое выражение и отправляет **POST** http-запрос с этим выражением на back-end. Примечание: Запросы должны быть **идемпотентными**. К запросам добавляется **уникальный идентификатор**. Если пользователь отправляет запрос с идентификатором, который уже отправлялся и был принят к обработке - ответ 200. Возможные варианты ответа:
    - _200_ - Выражение успешно принято, распаршено и принято к обработке
    - _400_ - Выражение невалидно
    - _500_ - Что-то не так на back-end. В качестве ответа нужно возвращать id принятного к выполнению выражения.
2) Страница со списком выражений в виде списка с выражениями. Каждая запись на странице содержит статус, выражение, дату его создания и дату заверщения вычисления. Страница получает данные GET http-запрсом с back-end-а
3) Страница со списком операций в виде пар: имя операции + время его выполнения (доступное для редактирования поле). Как уже оговаривалось в условии задачи, наши операции выполняются "как будто бы очень долго". Страница получает данные GET http-запрсом с back-end-а. Пользователь может настроить время выполения операции и сохранить изменения.
4) Страница со списком вычислительных можностей. Страница получает данные GET http-запросом с сервера в виде пар: имя вычислительного ресурса + выполняемая на нём операция.

### Требования:

1) Оркестратор может перезапускаться без потери состояния. Все выражения храним в СУБД.
2) Оркестратор должен отслеживать задачи, которые выполняются слишком долго (вычислитель тоже может уйти со связи) и делать их повторно доступными для вычислений.


## Back-end часть

### Состоит из 2 элементов:

- Сервер, который принимает арифметическое выражение, переводит его в набор последовательных задач и обеспечивает порядок их выполнения. Далее будем называть его оркестратором.
- Вычислитель, который может получить от оркестратора задачу, выполнить его и вернуть серверу результат. Далее будем называть его агентом.

### Оркестратор
Сервер, который имеет следующие endpoint-ы:

- Добавление вычисления арифметического выражения.
- Получение списка выражений со статусами.
- Получение значения выражения по его идентификатору.
- Получение списка доступных операций со временем их выполения.
- Получение задачи для выполения.
- Приём результата обработки данных.


### Агент
Демон, который получает выражение для вычисления с сервера, вычисляет его и отправляет на сервер результат выражения. При старте демон запускает несколько горутин, каждая из которых выступает в роли независимого вычислителя. Количество горутин регулируется переменной среды.


</details>


http://localhost:8080/
## Инструкция к запуску:
Хотел сделать docker контейнер - успехом не увенчалось :)
Ошибка была такая `dial error (dial tcp [::1]:8100: connect: cannot assign requested address)`
Означает что если ваша база данных находится на хосте, вы не можете установить «localhost» из контейнера, поскольку он будет нацелен на сам контейнер, а не на хост-компьютер.
Времени разбирать не осталось, но можете попробовать, Dockerfile и docker-compose есть. Docker запускал через IDEA. Если сможете решить проблему - буду рад узнать как вы сделали. Поэтому способ дедовский:
1. Склонировать проект или скачать 
2. Установить PostgreSQL
3. Поменять в config.json данные о PostgreSQL(и другие если хотите)
4. Установить все зависимости из go.mod `go mod download`
5. Включить сервер PostgreSQL
6. Запустить файл main.go

## Какие ошибки обрабатывааются в выражении:

Сначала RemoveAllSpaces убирает пробелы в выражении
- HasDoubleSymbol проверяет на двойной символ
- IsValidParentheses проверяет скобочную последовательность
- HasDivizionByZero проверяет есть ли деление на ноль
- HasValidCharacters проверяет на допустимые символы
- ContainsCorrectFloatPoint проверяет на точку в правильном месте(должно быть в числе float)
- HasAtLeastOneExpression проверяет на хотя бы одно выражение число оператор число
- ExpressionStartsWithNumber проверяет - первым ли идёт число или скобка в выражении
## Как работает подсчёт выражения:

1. Делаем постфиксную запись выражения
2. Ищем выражения вида `24+` (число число оператор) или ищем выражения вида `2 + 2 +` (число оператор число оператор((операторы одинаковые)))
3. Отправляем субвыражения на горутины(агенты)
4. Подставляем обратно в постфиксную запись наши субвыражения
5. Повторяем пока не останется одно число

## Какие запросы можем сделать и как:

Запросы делал через Postman
- `http://localhost:8080/expression` - метод POST и Body например такое(отправляем выражение на обработку):
```json
{
    "expression": "(2+2)*2"
}
```
![alt tag](https://github.com/byoverr/arithmetic_operations/blob/main/img/example.png "Пример")
- `http://localhost:8080/expression` метод GET - получаем все выражения
- `http://localhost:8080/expression/1` метод GET - получаем выражение с id = 1
- `http://localhost:8080/operation` метод GET - получаем все операции(длительность операции)
- `http://localhost:8080/operation` метод PUT - обновляем операцию тут Body будет например такое:
```json
{
    "operation": {
    "addition": 200,
    "subtraction": 2000,
    "multiplication": 200,
    "division": 200
  }
}
```

## Как это все работает:

![alt tag](https://github.com/byoverr/arithmetic_operations/blob/main/img/scheme.png "Схемка")
У нас читается конфиг с файла config.json, инициализируется БД, chi роутер и привязываются паттерны. По вызванному паттерну есть хендлер в котором обрабатывается запрос и идет работа с БД, создаются таски с выражениями и длительностью операций. Всё обрабатывается и возвращается ответ.

Используемые технологии:

*chi, viper, pgx, slog, postgresql, docker(я пытался)*

По всем вопросам и не вопросам пишите в [Telegram](https://t.me/super_serejka)
